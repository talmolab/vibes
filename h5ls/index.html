<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>h5ls - HDF5 File Explorer</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        h1 { margin-bottom: 0.5rem; color: #fff; }
        .description { color: #aaa; margin-top: 0; }
        .container { max-width: 1000px; margin: 0 auto; }
        .controls {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #5568d3; }
        button:disabled { background: #444; cursor: not-allowed; }
        .url-input-container {
            display: none;
            margin-top: 15px;
            gap: 10px;
            align-items: center;
        }
        .url-input-container.visible { display: flex; }
        .url-input {
            flex: 1;
            background: #1a1a1a;
            border: 1px solid #444;
            color: #e0e0e0;
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 16px;
        }
        .url-input:focus { outline: none; border-color: #667eea; }
        .file-info {
            background: #2a2a2a;
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
        .file-info.visible { display: block; }
        .file-info h2 { margin: 0 0 10px 0; color: #667eea; font-size: 16px; }
        .file-meta { color: #aaa; font-size: 14px; }
        .tree-container {
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 500px;
            overflow-y: auto;
            display: none;
        }
        .tree-container.visible { display: block; }
        .tree-item { margin: 4px 0; padding: 4px 8px; border-radius: 4px; }
        .tree-item:hover { background: #1a1a1a; }
        .tree-group { color: #fbbf24; }
        .tree-dataset { color: #4ade80; }
        .tree-indent { display: inline-block; }
        .tree-shape { color: #667eea; }
        .tree-dtype { color: #f472b6; }
        .tree-size { color: #888; }
        .tree-attrs { color: #06b6d4; font-size: 11px; }
        .diagnostic-console {
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 8px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 11px;
        }
        .diagnostic-console-header {
            background: #2a2a2a;
            padding: 8px 15px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .diagnostic-console-header h3 { margin: 0; color: #fff; font-size: 12px; }
        .diagnostic-console-header button {
            background: #444;
            padding: 4px 10px;
            font-size: 11px;
            margin: 0;
        }
        .diagnostic-console-body {
            height: 150px;
            overflow-y: auto;
            padding: 10px 15px;
        }
        .log-entry { margin: 2px 0; display: flex; gap: 10px; }
        .log-time { color: #666; flex-shrink: 0; }
        .log-msg { color: #aaa; }
        .log-msg.info { color: #667eea; }
        .log-msg.success { color: #4ade80; }
        .log-msg.warn { color: #fbbf24; }
        .log-msg.error { color: #ff6b6b; }
        .loading {
            display: none;
            align-items: center;
            gap: 10px;
            color: #667eea;
            margin: 20px 0;
        }
        .loading.visible { display: flex; }
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #333;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 600px) {
            body { padding: 15px; }
            .controls { padding: 15px; }
            button { padding: 10px 16px; font-size: 14px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>h5ls</h1>
        <p class="description">Explore HDF5/SLP file structure without downloading the entire file. Lists datasets, shapes, dtypes, and attributes.</p>

        <div class="controls">
            <button id="loadLocalBtn">Open Local File</button>
            <button id="loadUrlBtn">Load from URL</button>
            <input type="file" id="fileInput" accept=".h5,.hdf5,.slp,.nwb" style="display: none;">
            <div class="url-input-container" id="urlContainer">
                <input type="text" class="url-input" id="urlInput" placeholder="Enter HDF5/SLP file URL (must support CORS)">
                <button id="urlLoadBtn">Load</button>
                <button id="urlCancelBtn" style="background: #444;">Cancel</button>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <span id="loadingText">Loading...</span>
        </div>

        <div class="file-info" id="fileInfo">
            <h2 id="fileName">-</h2>
            <div class="file-meta">
                <span id="fileSize">-</span> |
                <span id="fileSource">-</span> |
                <span id="datasetCount">-</span> datasets |
                <span id="groupCount">-</span> groups
            </div>
        </div>

        <div class="tree-container" id="treeContainer"></div>

        <div class="diagnostic-console">
            <div class="diagnostic-console-header">
                <h3>Log</h3>
                <button id="copyLogBtn">Copy</button>
            </div>
            <div class="diagnostic-console-body" id="logBody"></div>
        </div>
    </div>

    <script type="module">
        const logBody = document.getElementById('logBody');
        const fileInfo = document.getElementById('fileInfo');
        const treeContainer = document.getElementById('treeContainer');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        const urlContainer = document.getElementById('urlContainer');
        const urlInput = document.getElementById('urlInput');
        const fileInput = document.getElementById('fileInput');

        let worker = null;

        function log(msg, level = 'info') {
            const time = new Date().toLocaleTimeString('en-US', {
                hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const timeSpan = document.createElement('span');
            timeSpan.className = 'log-time';
            timeSpan.textContent = time;
            const msgSpan = document.createElement('span');
            msgSpan.className = `log-msg ${level}`;
            msgSpan.textContent = msg;
            entry.appendChild(timeSpan);
            entry.appendChild(msgSpan);
            logBody.appendChild(entry);
            logBody.scrollTop = logBody.scrollHeight;
        }

        document.getElementById('copyLogBtn').addEventListener('click', () => {
            const lines = Array.from(logBody.querySelectorAll('.log-entry')).map(entry => {
                const time = entry.querySelector('.log-time').textContent;
                const msg = entry.querySelector('.log-msg').textContent;
                return `${time} ${msg}`;
            });
            navigator.clipboard.writeText(lines.join('\n')).then(() => {
                log('Log copied to clipboard', 'success');
            }).catch(() => {
                const ta = document.createElement('textarea');
                ta.value = lines.join('\n');
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                log('Log copied to clipboard', 'success');
            });
        });

        function showLoading(text) {
            loadingText.textContent = text;
            loading.classList.add('visible');
        }

        function hideLoading() {
            loading.classList.remove('visible');
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDtype(dtype) {
            if (typeof dtype === 'object') {
                if (dtype.compound_type) return 'compound';
                if (dtype.vlen_type) return `vlen<${dtype.vlen_type}>`;
                return 'compound';
            }
            return String(dtype);
        }

        function initWorker() {
            if (worker) worker.terminate();

            worker = new Worker('./worker.js');

            worker.onmessage = (e) => {
                const { type, data } = e.data;

                if (type === 'log') {
                    log(data.message, data.level);
                } else if (type === 'loading') {
                    showLoading(data.message);
                } else if (type === 'result') {
                    hideLoading();
                    displayResults(data);
                } else if (type === 'error') {
                    hideLoading();
                    log(`Error: ${data.message}`, 'error');
                }
            };

            worker.onerror = (e) => {
                hideLoading();
                log(`Worker error: ${e.message}`, 'error');
            };
        }

        function displayResults(data) {
            // Update file info
            document.getElementById('fileName').textContent = data.filename;
            document.getElementById('fileSize').textContent = formatBytes(data.fileSize);
            document.getElementById('fileSource').textContent = data.source;
            document.getElementById('datasetCount').textContent = data.datasets.length;
            document.getElementById('groupCount').textContent = data.groups.length;
            fileInfo.classList.add('visible');

            // Build tree view
            treeContainer.innerHTML = '';
            const tree = buildTree(data.datasets, data.groups);
            renderTree(tree, treeContainer, 0);
            treeContainer.classList.add('visible');

            log(`Loaded ${data.datasets.length} datasets and ${data.groups.length} groups`, 'success');
        }

        function buildTree(datasets, groups) {
            const root = { children: {}, items: [] };

            // Add groups
            for (const g of groups) {
                const parts = g.path.split('/').filter(p => p);
                let node = root;
                for (const part of parts) {
                    if (!node.children[part]) {
                        node.children[part] = { children: {}, items: [], isGroup: true };
                    }
                    node = node.children[part];
                }
                node.attrs = g.attrs || [];
            }

            // Add datasets
            for (const ds of datasets) {
                const parts = ds.path.split('/').filter(p => p);
                const name = parts.pop();
                let node = root;
                for (const part of parts) {
                    if (!node.children[part]) {
                        node.children[part] = { children: {}, items: [], isGroup: true };
                    }
                    node = node.children[part];
                }
                node.items.push({ name, ...ds });
            }

            return root;
        }

        function renderTree(node, container, depth) {
            const indent = '  '.repeat(depth);

            // Render child groups first
            const sortedGroups = Object.keys(node.children).sort();
            for (const name of sortedGroups) {
                const child = node.children[name];
                const div = document.createElement('div');
                div.className = 'tree-item';

                let html = `<span class="tree-indent">${indent}</span>`;
                html += `<span class="tree-group">${name}/</span>`;
                if (child.attrs && child.attrs.length > 0) {
                    html += ` <span class="tree-attrs">[attrs: ${child.attrs.join(', ')}]</span>`;
                }
                div.innerHTML = html;
                container.appendChild(div);

                renderTree(child, container, depth + 1);
            }

            // Render datasets
            const sortedItems = node.items.sort((a, b) => a.name.localeCompare(b.name));
            for (const item of sortedItems) {
                const div = document.createElement('div');
                div.className = 'tree-item';

                const dtype = formatDtype(item.dtype);
                const shape = item.shape.length > 0 ? `[${item.shape.join(', ')}]` : '[]';
                const size = item.size > 0 ? ` (${item.size.toLocaleString()} elements)` : '';

                let html = `<span class="tree-indent">${indent}</span>`;
                html += `<span class="tree-dataset">${item.name}</span>`;
                html += ` <span class="tree-shape">${shape}</span>`;
                html += ` <span class="tree-dtype">${dtype}</span>`;
                html += `<span class="tree-size">${size}</span>`;
                if (item.attrs && item.attrs.length > 0) {
                    html += ` <span class="tree-attrs">[attrs: ${item.attrs.join(', ')}]</span>`;
                }
                div.innerHTML = html;
                container.appendChild(div);
            }
        }

        // Load local file
        document.getElementById('loadLocalBtn').addEventListener('click', async () => {
            if ('showOpenFilePicker' in window) {
                try {
                    const [handle] = await window.showOpenFilePicker({
                        types: [{
                            description: 'HDF5 files',
                            accept: { 'application/x-hdf5': ['.h5', '.hdf5', '.slp', '.nwb'] }
                        }],
                        multiple: false
                    });
                    const file = await handle.getFile();
                    log(`Loading local file: ${file.name}`, 'info');
                    initWorker();
                    showLoading('Initializing h5wasm...');
                    worker.postMessage({ type: 'loadLocal', file });
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        log(`Error: ${err.message}`, 'error');
                        fileInput.click();
                    }
                }
            } else {
                fileInput.click();
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            log(`Loading file: ${file.name}`, 'info');
            initWorker();
            showLoading('Initializing h5wasm...');
            worker.postMessage({ type: 'loadLocal', file });
        });

        // Load from URL
        document.getElementById('loadUrlBtn').addEventListener('click', () => {
            urlContainer.classList.add('visible');
            urlInput.focus();
        });

        document.getElementById('urlCancelBtn').addEventListener('click', () => {
            urlContainer.classList.remove('visible');
            urlInput.value = '';
        });

        document.getElementById('urlLoadBtn').addEventListener('click', () => {
            const url = urlInput.value.trim();
            if (!url) return;
            urlContainer.classList.remove('visible');
            log(`Loading from URL: ${url}`, 'info');
            initWorker();
            showLoading('Checking server...');
            worker.postMessage({ type: 'loadUrl', url });
        });

        urlInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') document.getElementById('urlLoadBtn').click();
            if (e.key === 'Escape') document.getElementById('urlCancelBtn').click();
        });

        log('h5ls ready', 'info');
    </script>
</body>
</html>
