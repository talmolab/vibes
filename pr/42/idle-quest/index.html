<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Idle Quest</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #eee;
            padding: 20px;
        }

        .game-container {
            max-width: 1100px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .panel {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .panel h2 {
            color: #ffd700;
            font-size: 1em;
            margin-bottom: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .icon {
            display: inline-block;
            width: 20px;
            text-align: center;
        }

        /* Custom icon styles */
        .coin-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            border-radius: 50%;
            border: 2px solid #cc8800;
            box-shadow: inset 0 -2px 4px rgba(0,0,0,0.3);
        }

        .coin-icon-sm {
            width: 12px;
            height: 12px;
            border-width: 1px;
        }

        /* Hero Section */
        .hero-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.85em;
        }

        .stat {
            background: rgba(0,0,0,0.2);
            padding: 8px;
            border-radius: 6px;
        }

        .stat-label {
            color: #888;
            font-size: 0.75em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-value {
            color: #4ecdc4;
            font-weight: bold;
            font-size: 1.1em;
        }

        .xp-bar-container {
            margin-top: 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            position: relative;
        }

        .xp-bar {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #44a08d);
            transition: width 0.3s ease;
        }

        .xp-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.7em;
            text-shadow: 1px 1px 2px black;
        }

        /* Combat Section */
        .enemy-display {
            text-align: center;
            padding: 10px;
        }

        .enemy-name {
            font-size: 1.1em;
            color: #ff6b6b;
            margin-bottom: 3px;
        }

        .enemy-level {
            color: #888;
            font-size: 0.8em;
            margin-bottom: 8px;
        }

        .enemy-hp-bar {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            height: 22px;
            overflow: hidden;
            position: relative;
            margin-bottom: 12px;
        }

        .enemy-hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #ee5a5a);
            transition: width 0.15s ease;
        }

        .enemy-hp-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.75em;
            text-shadow: 1px 1px 2px black;
        }

        .attack-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
            border: none;
            color: white;
            padding: 12px 35px;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.1s ease;
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .attack-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(255,107,107,0.4);
        }

        .attack-btn:active {
            transform: scale(0.95);
        }

        /* Resources */
        .resources {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .resource {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 6px;
        }

        .resource-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .resource-icon {
            font-size: 1.1em;
            width: 22px;
            text-align: center;
        }

        .resource-value {
            font-weight: bold;
            font-size: 1.1em;
            transition: all 0.2s;
        }

        .gold-value { color: #ffd700; }
        .gems-icon { color: #a855f7; }
        .gems-value { color: #a855f7; }
        .souls-icon { color: #60a5fa; }
        .souls-value { color: #60a5fa; }

        /* Upgrades */
        .upgrades-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 280px;
            overflow-y: auto;
        }

        .upgrade {
            background: rgba(0,0,0,0.2);
            padding: 8px 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .upgrade:hover {
            background: rgba(0,0,0,0.3);
        }

        .upgrade-info h3 {
            font-size: 0.85em;
            color: #4ecdc4;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .upgrade-info p {
            font-size: 0.7em;
            color: #888;
        }

        .upgrade-info .level {
            color: #ffd700;
            font-size: 0.65em;
        }

        .upgrade-btn {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.75em;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .upgrade-btn:hover:not(:disabled) {
            transform: scale(1.05);
        }

        .upgrade-btn:disabled {
            background: #444;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Stats & Charts Panel */
        .stats-panel {
            grid-column: span 1;
        }

        .chart-container {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .chart-title {
            font-size: 0.75em;
            color: #888;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .mini-chart {
            height: 60px;
            display: flex;
            align-items: flex-end;
            gap: 2px;
        }

        .chart-bar {
            flex: 1;
            background: linear-gradient(to top, #4ecdc4, #44a08d);
            border-radius: 2px 2px 0 0;
            min-height: 2px;
            transition: height 0.3s ease;
        }

        .chart-bar.gold-bar {
            background: linear-gradient(to top, #ffd700, #f4c430);
        }

        .chart-bar.dps-bar {
            background: linear-gradient(to top, #ff6b6b, #ee5a5a);
        }

        .lifetime-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            font-size: 0.8em;
        }

        .lifetime-stat {
            background: rgba(0,0,0,0.2);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }

        .lifetime-stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #4ecdc4;
        }

        .lifetime-stat-label {
            font-size: 0.7em;
            color: #888;
        }

        /* Big number display */
        .big-number-display {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            margin-bottom: 10px;
        }

        .big-number-label {
            font-size: 0.7em;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .big-number {
            font-size: 2em;
            font-weight: bold;
            color: #ffd700;
            font-family: 'Courier New', monospace;
        }

        .big-number-sub {
            font-size: 0.75em;
            color: #4ecdc4;
        }

        /* Auto-battle toggle */
        .auto-battle {
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 0.85em;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #444;
            transition: 0.3s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #4ecdc4;
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        /* Damage numbers */
        .damage-float {
            position: fixed;
            pointer-events: none;
            font-weight: bold;
            font-size: 1.1em;
            text-shadow: 2px 2px 2px black;
            animation: float-up 0.8s ease-out forwards;
            z-index: 1000;
        }

        @keyframes float-up {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            50% {
                transform: translateY(-25px) scale(1.1);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px) scale(0.8);
            }
        }

        /* Zone selector */
        .zone-selector {
            display: flex;
            gap: 4px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .zone-btn {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            color: #888;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7em;
            transition: all 0.2s;
        }

        .zone-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        .zone-btn.active {
            background: rgba(78, 205, 196, 0.3);
            border-color: #4ecdc4;
            color: #4ecdc4;
        }

        .zone-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* DPS display */
        .dps-display {
            text-align: center;
            margin-top: 8px;
            color: #888;
            font-size: 0.8em;
        }

        .dps-value {
            color: #ff6b6b;
            font-weight: bold;
        }

        /* Save indicator */
        .save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(78, 205, 196, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 0.8em;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .save-indicator.show {
            opacity: 1;
        }

        /* Save Panel */
        .save-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 8px;
        }

        .save-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(30, 30, 50, 0.9);
            color: #eee;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .save-btn:hover {
            background: rgba(78, 205, 196, 0.3);
            border-color: #4ecdc4;
            transform: scale(1.1);
        }

        /* Prestige button */
        .prestige-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .prestige-btn {
            width: 100%;
            background: linear-gradient(135deg, #a855f7, #7c3aed);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .prestige-btn:hover:not(:disabled) {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4);
        }

        .prestige-btn:disabled {
            background: #444;
            cursor: not-allowed;
        }

        .prestige-info {
            font-size: 0.7em;
            color: #888;
            margin-top: 5px;
            text-align: center;
        }

        /* Combat Log */
        .combat-log-container {
            grid-column: span 3;
        }

        .combat-log {
            height: 100px;
            overflow-y: auto;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            padding: 8px;
            font-size: 0.75em;
        }

        .log-entry {
            padding: 2px 0;
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }

        .log-damage { color: #ff6b6b; }
        .log-gold { color: #ffd700; }
        .log-xp { color: #4ecdc4; }
        .log-level { color: #a855f7; }
        .log-boss { color: #ff9f43; }

        /* Progress bars for milestones */
        .milestone-section {
            margin-top: 10px;
        }

        .milestone {
            margin-bottom: 8px;
        }

        .milestone-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.7em;
            margin-bottom: 3px;
        }

        .milestone-name {
            color: #888;
        }

        .milestone-progress {
            color: #4ecdc4;
        }

        .milestone-bar {
            height: 6px;
            background: rgba(0,0,0,0.3);
            border-radius: 3px;
            overflow: hidden;
        }

        .milestone-fill {
            height: 100%;
            background: linear-gradient(90deg, #a855f7, #7c3aed);
            transition: width 0.3s ease;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 5px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
        }

        @media (max-width: 900px) {
            .main-grid {
                grid-template-columns: 1fr 1fr;
            }
            .combat-log-container {
                grid-column: span 2;
            }
            .stats-panel {
                grid-column: span 2;
            }
        }

        @media (max-width: 600px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            .combat-log-container, .stats-panel {
                grid-column: span 1;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>âš” Idle Quest âš”</h1>
        
        <div class="main-grid">
            <!-- Left Column - Hero & Combat -->
            <div>
                <!-- Hero Panel -->
                <div class="panel">
                    <h2>ðŸ§™ Hero</h2>
                    <div class="hero-stats">
                        <div class="stat">
                            <div class="stat-label">âœ¦ Level</div>
                            <div class="stat-value" id="hero-level">1</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">âš” Attack</div>
                            <div class="stat-value" id="hero-attack">1</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">â—‰ Crit %</div>
                            <div class="stat-value" id="hero-crit">5%</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">âš¡ Crit Dmg</div>
                            <div class="stat-value" id="hero-crit-dmg">150%</div>
                        </div>
                    </div>
                    <div class="xp-bar-container">
                        <div class="xp-bar" id="xp-bar"></div>
                        <div class="xp-text" id="xp-text">0 / 100 XP</div>
                    </div>
                </div>

                <!-- Combat Panel -->
                <div class="panel" style="margin-top: 15px;">
                    <h2>âš” Combat</h2>
                    <div class="zone-selector" id="zone-selector"></div>
                    <div class="enemy-display">
                        <div class="enemy-name" id="enemy-name">Slime</div>
                        <div class="enemy-level" id="enemy-level">Level 1</div>
                        <div class="enemy-hp-bar">
                            <div class="enemy-hp-fill" id="enemy-hp-bar"></div>
                            <div class="enemy-hp-text" id="enemy-hp-text">100 / 100</div>
                        </div>
                        <button class="attack-btn" id="attack-btn">âš” ATTACK!</button>
                        <div class="auto-battle">
                            <span>Auto-Battle</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="auto-battle-toggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="dps-display">
                            DPS: <span class="dps-value" id="dps-display">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Middle Column - Resources & Upgrades -->
            <div>
                <!-- Resources Panel -->
                <div class="panel">
                    <h2>ðŸ’° Resources</h2>
                    <div class="resources">
                        <div class="resource">
                            <div class="resource-name">
                                <span class="coin-icon"></span>
                                <span>Gold</span>
                            </div>
                            <span class="resource-value gold-value" id="gold">0</span>
                        </div>
                        <div class="resource">
                            <div class="resource-name">
                                <span class="resource-icon gems-icon">ðŸ’Ž</span>
                                <span>Gems</span>
                            </div>
                            <span class="resource-value gems-value" id="gems">0</span>
                        </div>
                        <div class="resource">
                            <div class="resource-name">
                                <span class="resource-icon souls-icon">ðŸ‘»</span>
                                <span>Soul Shards</span>
                            </div>
                            <span class="resource-value souls-value" id="souls">0</span>
                        </div>
                    </div>
                    <div class="prestige-section">
                        <button class="prestige-btn" id="prestige-btn" disabled>
                            â†» Prestige (Zone 5)
                        </button>
                        <div class="prestige-info">
                            Reset for <span id="prestige-souls">0</span> Soul Shards (+1% dmg each)
                        </div>
                    </div>
                </div>

                <!-- Upgrades Panel -->
                <div class="panel" style="margin-top: 15px;">
                    <h2>â†‘ Upgrades</h2>
                    <div class="upgrades-list" id="upgrades-list"></div>
                </div>
            </div>

            <!-- Right Column - Stats & Progression -->
            <div class="stats-panel">
                <div class="panel">
                    <h2>ðŸ“ˆ Progression</h2>
                    
                    <!-- Big Total Gold Display -->
                    <div class="big-number-display">
                        <div class="big-number-label">Total Gold Earned</div>
                        <div class="big-number" id="total-gold">0</div>
                        <div class="big-number-sub">
                            â–² <span id="gold-per-sec">0</span>/sec
                        </div>
                    </div>

                    <!-- DPS Chart -->
                    <div class="chart-container">
                        <div class="chart-title">
                            â–“ Damage History
                        </div>
                        <div class="mini-chart" id="dps-chart"></div>
                    </div>

                    <!-- Gold Chart -->
                    <div class="chart-container">
                        <div class="chart-title">
                            â–“ Gold Income
                        </div>
                        <div class="mini-chart" id="gold-chart"></div>
                    </div>

                    <!-- Lifetime Stats -->
                    <div class="lifetime-stats">
                        <div class="lifetime-stat">
                            <div class="lifetime-stat-value" id="enemies-killed">0</div>
                            <div class="lifetime-stat-label">Enemies Slain</div>
                        </div>
                        <div class="lifetime-stat">
                            <div class="lifetime-stat-value" id="bosses-killed">0</div>
                            <div class="lifetime-stat-label">Bosses Slain</div>
                        </div>
                        <div class="lifetime-stat">
                            <div class="lifetime-stat-value" id="total-damage">0</div>
                            <div class="lifetime-stat-label">Total Damage</div>
                        </div>
                        <div class="lifetime-stat">
                            <div class="lifetime-stat-value" id="prestige-count">0</div>
                            <div class="lifetime-stat-label">Prestiges</div>
                        </div>
                    </div>

                    <!-- Milestones -->
                    <div class="milestone-section">
                        <div class="milestone">
                            <div class="milestone-header">
                                <span class="milestone-name">â˜  Next Zone</span>
                                <span class="milestone-progress" id="zone-progress">0/10</span>
                            </div>
                            <div class="milestone-bar">
                                <div class="milestone-fill" id="zone-progress-bar"></div>
                            </div>
                        </div>
                        <div class="milestone">
                            <div class="milestone-header">
                                <span class="milestone-name">â™› Next Boss</span>
                                <span class="milestone-progress" id="boss-progress">0/5</span>
                            </div>
                            <div class="milestone-bar">
                                <div class="milestone-fill" id="boss-progress-bar"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Combat Log -->
            <div class="panel combat-log-container">
                <h2>ðŸ“œ Combat Log</h2>
                <div class="combat-log" id="combat-log"></div>
            </div>
        </div>
    </div>

    <div class="save-indicator" id="save-indicator">âœ“ Game Saved!</div>

    <!-- Save Management Panel -->
    <div class="save-panel">
        <button class="save-btn" onclick="saveGame()" title="Save Game">ðŸ’¾</button>
        <button class="save-btn" onclick="exportSave()" title="Export Save">â¬‡</button>
        <button class="save-btn" onclick="document.getElementById('import-file').click()" title="Import Save">â¬†</button>
        <input type="file" id="import-file" accept=".json" style="display:none" onchange="importSave(event)">
    </div>

    <script>
        // Upgrade icons defined separately (not saved)
        const UPGRADE_ICONS = {
            attackPower: 'âš”',
            critChance: 'â—‰',
            critDamage: 'âš¡',
            goldBonus: 'â—',
            xpBonus: 'â˜…',
            autoSpeed: 'Â»'
        };

        // Game State
        const game = {
            hero: {
                level: 1,
                xp: 0,
                xpToLevel: 100,
                baseAttack: 1,
                critChance: 0.05,
                critDamage: 1.5
            },
            resources: {
                gold: 0,
                gems: 0,
                souls: 0
            },
            stats: {
                totalGold: 0,
                totalDamage: 0,
                enemiesKilled: 0,
                bossesKilled: 0,
                killsSinceZone: 0,
                killsSinceBoss: 0
            },
            upgrades: {
                attackPower: { level: 0, baseCost: 10, costMult: 1.15, effect: 1 },
                critChance: { level: 0, baseCost: 50, costMult: 1.25, effect: 0.01 },
                critDamage: { level: 0, baseCost: 75, costMult: 1.2, effect: 0.1 },
                goldBonus: { level: 0, baseCost: 25, costMult: 1.18, effect: 0.1 },
                xpBonus: { level: 0, baseCost: 40, costMult: 1.2, effect: 0.05 },
                autoSpeed: { level: 0, baseCost: 100, costMult: 1.3, effect: 50 }
            },
            currentZone: 0,
            highestZone: 0,
            enemy: null,
            autoBattle: false,
            prestigeCount: 0,
            dpsHistory: new Array(20).fill(0),
            goldHistory: new Array(20).fill(0),
            recentDamage: 0,
            recentGold: 0,
            lastTickTime: Date.now()
        };

        const zones = [
            { name: "Forest", enemies: ["Slime", "Goblin", "Wolf", "Bandit", "Forest Troll"], baseHp: 50, baseGold: 5, baseXp: 10 },
            { name: "Cave", enemies: ["Bat", "Spider", "Skeleton", "Dark Slime", "Cave Ogre"], baseHp: 150, baseGold: 15, baseXp: 25 },
            { name: "Ruins", enemies: ["Ghost", "Zombie", "Wraith", "Cursed Knight", "Lich"], baseHp: 400, baseGold: 40, baseXp: 60 },
            { name: "Volcano", enemies: ["Fire Imp", "Lava Slime", "Magma Golem", "Phoenix", "Fire Dragon"], baseHp: 1000, baseGold: 100, baseXp: 150 },
            { name: "Abyss", enemies: ["Demon", "Shadow Beast", "Void Walker", "Abyssal Horror", "Demon Lord"], baseHp: 2500, baseGold: 250, baseXp: 350 },
            { name: "Heaven", enemies: ["Seraph", "Divine Guard", "Celestial", "Archangel", "God"], baseHp: 6000, baseGold: 600, baseXp: 800 }
        ];

        // DOM Elements
        const elements = {
            heroLevel: document.getElementById('hero-level'),
            heroAttack: document.getElementById('hero-attack'),
            heroCrit: document.getElementById('hero-crit'),
            heroCritDmg: document.getElementById('hero-crit-dmg'),
            xpBar: document.getElementById('xp-bar'),
            xpText: document.getElementById('xp-text'),
            gold: document.getElementById('gold'),
            gems: document.getElementById('gems'),
            souls: document.getElementById('souls'),
            enemyName: document.getElementById('enemy-name'),
            enemyLevel: document.getElementById('enemy-level'),
            enemyHpBar: document.getElementById('enemy-hp-bar'),
            enemyHpText: document.getElementById('enemy-hp-text'),
            attackBtn: document.getElementById('attack-btn'),
            autoBattleToggle: document.getElementById('auto-battle-toggle'),
            upgradesList: document.getElementById('upgrades-list'),
            combatLog: document.getElementById('combat-log'),
            zoneSelector: document.getElementById('zone-selector'),
            dpsDisplay: document.getElementById('dps-display'),
            saveIndicator: document.getElementById('save-indicator'),
            prestigeBtn: document.getElementById('prestige-btn'),
            prestigeSouls: document.getElementById('prestige-souls'),
            totalGold: document.getElementById('total-gold'),
            goldPerSec: document.getElementById('gold-per-sec'),
            enemiesKilled: document.getElementById('enemies-killed'),
            bossesKilled: document.getElementById('bosses-killed'),
            totalDamage: document.getElementById('total-damage'),
            prestigeCount: document.getElementById('prestige-count'),
            dpsChart: document.getElementById('dps-chart'),
            goldChart: document.getElementById('gold-chart'),
            zoneProgress: document.getElementById('zone-progress'),
            zoneProgressBar: document.getElementById('zone-progress-bar'),
            bossProgress: document.getElementById('boss-progress'),
            bossProgressBar: document.getElementById('boss-progress-bar')
        };

        // Utility Functions
        function formatNumber(num) {
            if (num >= 1e15) return (num / 1e15).toFixed(2) + 'Q';
            if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
            return Math.floor(num).toString();
        }

        function getUpgradeCost(upgrade) {
            return Math.floor(upgrade.baseCost * Math.pow(upgrade.costMult, upgrade.level));
        }

        function getTotalAttack() {
            const soulBonus = 1 + (game.resources.souls * 0.01);
            return Math.floor((game.hero.baseAttack + game.hero.level + (game.upgrades.attackPower.level * game.upgrades.attackPower.effect)) * soulBonus);
        }

        function getCritChance() {
            return Math.min(0.75, game.hero.critChance + (game.upgrades.critChance.level * game.upgrades.critChance.effect));
        }

        function getCritDamage() {
            return game.hero.critDamage + (game.upgrades.critDamage.level * game.upgrades.critDamage.effect);
        }

        function getGoldBonus() {
            return 1 + (game.upgrades.goldBonus.level * game.upgrades.goldBonus.effect);
        }

        function getXpBonus() {
            return 1 + (game.upgrades.xpBonus.level * game.upgrades.xpBonus.effect);
        }

        function getAutoSpeed() {
            return Math.max(100, 500 - (game.upgrades.autoSpeed.level * game.upgrades.autoSpeed.effect));
        }

        // Spawn Enemy
        function spawnEnemy() {
            const zone = zones[game.currentZone];
            const enemyIndex = Math.floor(Math.random() * zone.enemies.length);
            const isBoss = game.stats.killsSinceBoss >= 4;
            const enemyLevel = game.currentZone * 5 + Math.floor(Math.random() * 5) + 1;
            
            const hpMult = isBoss ? 5 : 1;
            const hp = Math.floor(zone.baseHp * (1 + enemyLevel * 0.2) * hpMult);
            
            game.enemy = {
                name: (isBoss ? 'â™› ' : '') + zone.enemies[enemyIndex],
                level: enemyLevel,
                hp: hp,
                maxHp: hp,
                isBoss: isBoss,
                gold: Math.floor(zone.baseGold * (1 + enemyLevel * 0.1) * (isBoss ? 3 : 1)),
                xp: Math.floor(zone.baseXp * (1 + enemyLevel * 0.1) * (isBoss ? 2 : 1)),
                gems: isBoss ? Math.floor(Math.random() * 3) + 1 : 0
            };
            
            if (isBoss) {
                game.stats.killsSinceBoss = 0;
            }
            
            updateEnemyDisplay();
            if (isBoss) {
                addLog('â™› A boss appears: ' + zone.enemies[enemyIndex] + '!', 'log-boss');
            }
        }

        // Attack
        var lastUIUpdate = 0;
        var pendingUIUpdate = false;
        
        function attack(isAuto = false) {
            if (!game.enemy || game.enemy.hp <= 0) {
                spawnEnemy();
                return;
            }

            const isCrit = Math.random() < getCritChance();
            let damage = getTotalAttack();
            if (isCrit) {
                damage = Math.floor(damage * getCritDamage());
            }

            game.enemy.hp -= damage;
            game.stats.totalDamage += damage;
            game.recentDamage += damage;

            // Only show some damage numbers during auto to reduce DOM updates
            if (!isAuto || Math.random() < 0.1) {
                showDamageNumber(damage, isCrit);
            }

            if (game.enemy.hp <= 0) {
                killEnemy();
            } else {
                // Throttle enemy HP bar updates during auto-battle
                var now = performance.now();
                if (!isAuto || now - lastUIUpdate > 50) {
                    updateEnemyDisplay();
                    lastUIUpdate = now;
                }
            }
        }

        function showDamageNumber(damage, isCrit) {
            const btn = elements.attackBtn;
            const rect = btn.getBoundingClientRect();
            
            const floater = document.createElement('div');
            floater.className = 'damage-float';
            floater.style.left = (rect.left + Math.random() * rect.width) + 'px';
            floater.style.top = (rect.top - 20) + 'px';
            floater.style.color = isCrit ? '#ffd700' : '#ff6b6b';
            floater.textContent = (isCrit ? 'âš¡ ' : '') + formatNumber(damage);
            
            document.body.appendChild(floater);
            setTimeout(() => floater.remove(), 800);
        }

        function killEnemy() {
            const goldEarned = Math.floor(game.enemy.gold * getGoldBonus());
            const xpEarned = Math.floor(game.enemy.xp * getXpBonus());
            
            game.resources.gold += goldEarned;
            game.stats.totalGold += goldEarned;
            game.recentGold += goldEarned;
            game.hero.xp += xpEarned;
            game.stats.enemiesKilled++;
            game.stats.killsSinceZone++;
            game.stats.killsSinceBoss++;
            
            if (game.enemy.isBoss) {
                game.stats.bossesKilled++;
            }
            
            if (game.enemy.gems > 0) {
                game.resources.gems += game.enemy.gems;
                addLog('ðŸ’Ž +' + game.enemy.gems + ' Gems!', 'log-level');
            }

            addLog('â˜  Enemy defeated! +' + formatNumber(goldEarned) + ' gold, +' + formatNumber(xpEarned) + ' XP', 'log-gold');

            while (game.hero.xp >= game.hero.xpToLevel) {
                game.hero.xp -= game.hero.xpToLevel;
                game.hero.level++;
                game.hero.xpToLevel = Math.floor(100 * Math.pow(1.15, game.hero.level - 1));
                addLog('â˜… Level Up! Now level ' + game.hero.level + '!', 'log-level');
            }

            if (game.stats.killsSinceZone >= 10 && game.currentZone < zones.length - 1) {
                if (game.currentZone === game.highestZone && game.highestZone < zones.length - 1) {
                    game.highestZone++;
                    game.stats.killsSinceZone = 0;
                    addLog('â¬† New zone unlocked: ' + zones[game.highestZone].name + '!', 'log-level');
                    updateZoneSelector();
                }
            }

            updateUI();
            spawnEnemy();
        }

        function addLog(message, className = '') {
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + className;
            entry.textContent = message;
            elements.combatLog.insertBefore(entry, elements.combatLog.firstChild);
            
            while (elements.combatLog.children.length > 50) {
                elements.combatLog.removeChild(elements.combatLog.lastChild);
            }
        }

        // Upgrades
        function buyUpgrade(key) {
            const upgrade = game.upgrades[key];
            const cost = getUpgradeCost(upgrade);
            
            if (game.resources.gold >= cost) {
                game.resources.gold -= cost;
                upgrade.level++;
                updateUI(true);
                renderUpgrades();
            }
        }

        function renderUpgrades() {
            const upgradeData = [
                { key: 'attackPower', name: 'Attack Power', desc: '+' + game.upgrades.attackPower.effect + ' base damage' },
                { key: 'critChance', name: 'Crit Chance', desc: '+' + (game.upgrades.critChance.effect * 100).toFixed(0) + '% crit chance' },
                { key: 'critDamage', name: 'Crit Damage', desc: '+' + (game.upgrades.critDamage.effect * 100).toFixed(0) + '% crit damage' },
                { key: 'goldBonus', name: 'Gold Find', desc: '+' + (game.upgrades.goldBonus.effect * 100).toFixed(0) + '% gold' },
                { key: 'xpBonus', name: 'XP Boost', desc: '+' + (game.upgrades.xpBonus.effect * 100).toFixed(0) + '% XP' },
                { key: 'autoSpeed', name: 'Auto Speed', desc: 'Faster auto-battle' }
            ];

            elements.upgradesList.innerHTML = upgradeData.map(function(item) {
                const upgrade = game.upgrades[item.key];
                const cost = getUpgradeCost(upgrade);
                const canAfford = game.resources.gold >= cost;
                const icon = UPGRADE_ICONS[item.key];
                
                return '<div class="upgrade">' +
                    '<div class="upgrade-info">' +
                        '<h3><span style="color:#ffd700">' + icon + '</span> ' + item.name + '</h3>' +
                        '<p>' + item.desc + '</p>' +
                        '<span class="level">Lv. ' + upgrade.level + '</span>' +
                    '</div>' +
                    '<button class="upgrade-btn" data-upgrade="' + item.key + '" ' + (!canAfford ? 'disabled' : '') + '>' +
                        '<span class="coin-icon coin-icon-sm"></span> ' + formatNumber(cost) +
                    '</button>' +
                '</div>';
            }).join('');
        }

        // Lighter update that only changes button states without full re-render
        function updateUpgradeButtons() {
            var buttons = elements.upgradesList.querySelectorAll('.upgrade-btn');
            buttons.forEach(function(btn) {
                var key = btn.getAttribute('data-upgrade');
                if (key && game.upgrades[key]) {
                    var cost = getUpgradeCost(game.upgrades[key]);
                    var canAfford = game.resources.gold >= cost;
                    btn.disabled = !canAfford;
                }
            });
        }

        // Zone Management
        function updateZoneSelector() {
            elements.zoneSelector.innerHTML = zones.map(function(zone, index) {
                const unlocked = index <= game.highestZone;
                const active = index === game.currentZone;
                return '<button class="zone-btn ' + (active ? 'active' : '') + '" ' +
                        'onclick="changeZone(' + index + ')" ' +
                        (!unlocked ? 'disabled' : '') + '>' +
                        zone.name +
                    '</button>';
            }).join('');
        }

        function changeZone(index) {
            if (index <= game.highestZone) {
                game.currentZone = index;
                game.stats.killsSinceZone = 0;
                spawnEnemy();
                updateZoneSelector();
                addLog('â†’ Traveled to ' + zones[index].name + '!', 'log-xp');
            }
        }

        // Auto Battle - using a single game loop instead of creating/destroying intervals
        var lastAutoAttack = 0;
        
        function toggleAutoBattle() {
            game.autoBattle = elements.autoBattleToggle.checked;
        }
        
        function gameLoop(timestamp) {
            if (game.autoBattle) {
                var speed = getAutoSpeed();
                if (timestamp - lastAutoAttack >= speed) {
                    attack(true);
                    lastAutoAttack = timestamp;
                }
            }
            requestAnimationFrame(gameLoop);
        }
        
        // Start the game loop once
        requestAnimationFrame(gameLoop);

        // Charts
        function updateCharts() {
            const now = Date.now();
            const elapsed = (now - game.lastTickTime) / 1000;
            
            if (elapsed >= 1) {
                const dps = game.recentDamage / elapsed;
                game.dpsHistory.shift();
                game.dpsHistory.push(dps);
                
                const gps = game.recentGold / elapsed;
                game.goldHistory.shift();
                game.goldHistory.push(gps);
                
                elements.dpsDisplay.textContent = formatNumber(dps);
                elements.goldPerSec.textContent = formatNumber(gps);
                
                game.recentDamage = 0;
                game.recentGold = 0;
                game.lastTickTime = now;
                
                renderChart(elements.dpsChart, game.dpsHistory, 'dps-bar');
                renderChart(elements.goldChart, game.goldHistory, 'gold-bar');
            }
        }

        function renderChart(container, data, barClass) {
            const max = Math.max.apply(null, data.concat([1]));
            container.innerHTML = data.map(function(value) {
                const height = Math.max(2, (value / max) * 100);
                return '<div class="chart-bar ' + barClass + '" style="height: ' + height + '%"></div>';
            }).join('');
        }

        // Prestige
        function prestige() {
            if (game.highestZone >= 4) {
                const soulsGained = calculatePrestigeSouls();
                game.resources.souls += soulsGained;
                game.prestigeCount++;
                
                // Stop auto-battle
                game.autoBattle = false;
                elements.autoBattleToggle.checked = false;
                
                game.hero.level = 1;
                game.hero.xp = 0;
                game.hero.xpToLevel = 100;
                game.resources.gold = 0;
                game.resources.gems = 0;
                game.currentZone = 0;
                game.highestZone = 0;
                game.stats.killsSinceZone = 0;
                game.stats.killsSinceBoss = 0;
                
                Object.keys(game.upgrades).forEach(function(key) {
                    game.upgrades[key].level = 0;
                });
                
                addLog('â†» Prestiged! Gained ' + soulsGained + ' Soul Shards!', 'log-level');
                spawnEnemy();
                updateUI(true);
                updateZoneSelector();
                renderUpgrades();
            }
        }

        function calculatePrestigeSouls() {
            return Math.floor(Math.pow(game.hero.level, 0.5) * (game.highestZone + 1));
        }

        function updatePrestigeButton() {
            const canPrestige = game.highestZone >= 4;
            elements.prestigeBtn.disabled = !canPrestige;
            elements.prestigeBtn.textContent = canPrestige ? 
                'â†» Prestige Now!' : 
                'âŠ˜ Prestige (Zone 5)';
            elements.prestigeSouls.textContent = calculatePrestigeSouls();
        }

        // UI Updates
        var lastFullUIUpdate = 0;
        
        function updateUI(force) {
            // Throttle UI updates unless forced
            var now = performance.now();
            if (!force && now - lastFullUIUpdate < 100) {
                return;
            }
            lastFullUIUpdate = now;
            
            elements.heroLevel.textContent = game.hero.level;
            elements.heroAttack.textContent = formatNumber(getTotalAttack());
            elements.heroCrit.textContent = (getCritChance() * 100).toFixed(1) + '%';
            elements.heroCritDmg.textContent = (getCritDamage() * 100).toFixed(0) + '%';
            
            const xpPercent = (game.hero.xp / game.hero.xpToLevel) * 100;
            elements.xpBar.style.width = xpPercent + '%';
            elements.xpText.textContent = formatNumber(game.hero.xp) + ' / ' + formatNumber(game.hero.xpToLevel) + ' XP';
            
            elements.gold.textContent = formatNumber(game.resources.gold);
            elements.gems.textContent = formatNumber(game.resources.gems);
            elements.souls.textContent = formatNumber(game.resources.souls);
            
            elements.totalGold.textContent = formatNumber(game.stats.totalGold);
            elements.enemiesKilled.textContent = formatNumber(game.stats.enemiesKilled);
            elements.bossesKilled.textContent = formatNumber(game.stats.bossesKilled);
            elements.totalDamage.textContent = formatNumber(game.stats.totalDamage);
            elements.prestigeCount.textContent = game.prestigeCount;
            
            const zoneKillsNeeded = 10;
            const zoneProgress = Math.min(game.stats.killsSinceZone, zoneKillsNeeded);
            elements.zoneProgress.textContent = zoneProgress + '/' + zoneKillsNeeded;
            elements.zoneProgressBar.style.width = (zoneProgress / zoneKillsNeeded) * 100 + '%';
            
            const bossKillsNeeded = 5;
            const bossProgress = Math.min(game.stats.killsSinceBoss, bossKillsNeeded);
            elements.bossProgress.textContent = bossProgress + '/' + bossKillsNeeded;
            elements.bossProgressBar.style.width = (bossProgress / bossKillsNeeded) * 100 + '%';
            
            updatePrestigeButton();
            updateUpgradeButtons();
        }

        function updateEnemyDisplay() {
            if (game.enemy) {
                elements.enemyName.textContent = game.enemy.name;
                elements.enemyLevel.textContent = 'Level ' + game.enemy.level;
                
                const hpPercent = Math.max(0, (game.enemy.hp / game.enemy.maxHp) * 100);
                elements.enemyHpBar.style.width = hpPercent + '%';
                elements.enemyHpText.textContent = formatNumber(Math.max(0, game.enemy.hp)) + ' / ' + formatNumber(game.enemy.maxHp);
            }
        }

        // Save/Load
        function saveGame() {
            const saveData = {
                hero: game.hero,
                resources: game.resources,
                stats: game.stats,
                upgrades: {},
                currentZone: game.currentZone,
                highestZone: game.highestZone,
                prestigeCount: game.prestigeCount
            };
            
            // Only save the numeric values of upgrades, not icons
            Object.keys(game.upgrades).forEach(function(key) {
                saveData.upgrades[key] = {
                    level: game.upgrades[key].level,
                    baseCost: game.upgrades[key].baseCost,
                    costMult: game.upgrades[key].costMult,
                    effect: game.upgrades[key].effect
                };
            });
            
            localStorage.setItem('idleQuestSave', JSON.stringify(saveData));
            
            elements.saveIndicator.classList.add('show');
            setTimeout(function() { elements.saveIndicator.classList.remove('show'); }, 1500);
        }

        function loadGame() {
            const savedData = localStorage.getItem('idleQuestSave');
            if (savedData) {
                applySaveData(savedData);
                addLog('âœ“ Game loaded!', 'log-xp');
            }
        }

        function applySaveData(jsonString) {
            try {
                const data = JSON.parse(jsonString);
                Object.assign(game.hero, data.hero);
                Object.assign(game.resources, data.resources);
                if (data.stats) Object.assign(game.stats, data.stats);
                
                // Load upgrade levels without overwriting base config
                if (data.upgrades) {
                    Object.keys(data.upgrades).forEach(function(key) {
                        if (game.upgrades[key]) {
                            game.upgrades[key].level = data.upgrades[key].level || 0;
                        }
                    });
                }
                
                game.currentZone = data.currentZone || 0;
                game.highestZone = data.highestZone || 0;
                game.prestigeCount = data.prestigeCount || 0;
                return true;
            } catch (e) {
                console.error('Failed to load save:', e);
                return false;
            }
        }

        function exportSave() {
            const saveData = {
                hero: game.hero,
                resources: game.resources,
                stats: game.stats,
                upgrades: {},
                currentZone: game.currentZone,
                highestZone: game.highestZone,
                prestigeCount: game.prestigeCount,
                exportDate: new Date().toISOString()
            };
            
            Object.keys(game.upgrades).forEach(function(key) {
                saveData.upgrades[key] = {
                    level: game.upgrades[key].level,
                    baseCost: game.upgrades[key].baseCost,
                    costMult: game.upgrades[key].costMult,
                    effect: game.upgrades[key].effect
                };
            });

            const blob = new Blob([JSON.stringify(saveData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'idle-quest-save-' + new Date().toISOString().slice(0,10) + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            addLog('â¬‡ Save exported!', 'log-xp');
        }

        function importSave(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                if (applySaveData(content)) {
                    // Also save to localStorage
                    localStorage.setItem('idleQuestSave', content);
                    spawnEnemy();
                    updateUI();
                    updateZoneSelector();
                    renderUpgrades();
                    addLog('â¬† Save imported successfully!', 'log-level');
                } else {
                    addLog('âœ— Failed to import save file!', 'log-damage');
                }
            };
            reader.readAsText(file);
            
            // Reset file input so same file can be selected again
            event.target.value = '';
        }

        // Save when closing/refreshing the page
        window.addEventListener('beforeunload', function() {
            saveGame();
        });

        // Event Listeners
        elements.attackBtn.addEventListener('click', function() { attack(false); });
        elements.autoBattleToggle.addEventListener('change', toggleAutoBattle);
        elements.prestigeBtn.addEventListener('click', prestige);
        
        // Use event delegation for upgrades so clicks work even during rapid re-renders
        elements.upgradesList.addEventListener('click', function(e) {
            const btn = e.target.closest('.upgrade-btn');
            if (btn && !btn.disabled) {
                const key = btn.getAttribute('data-upgrade');
                if (key) buyUpgrade(key);
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space' && !e.repeat) {
                e.preventDefault();
                attack(false);
            }
        });

        // Initialize
        function init() {
            loadGame();
            updateZoneSelector();
            spawnEnemy();
            renderUpgrades();
            updateUI(true);
            
            renderChart(elements.dpsChart, game.dpsHistory, 'dps-bar');
            renderChart(elements.goldChart, game.goldHistory, 'gold-bar');
            
            setInterval(saveGame, 30000);
            
            setInterval(function() {
                updateUI(true);
                updateCharts();
            }, 1000);
            
            addLog('âš” Welcome to Idle Quest! Click or press Space to attack!', 'log-xp');
        }

        init();
    </script>
</body>
</html>
