<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Stats Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border: #30363d;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --accent-green: #238636;
            --accent-blue: #58a6ff;
            --accent-purple: #a371f7;
            --accent-orange: #f78166;
            --accent-pink: #db61a2;
            --accent-yellow: #d29922;
            --gradient: linear-gradient(135deg, #58a6ff 0%, #a371f7 50%, #db61a2 100%);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 24px; }
        header {
            text-align: center;
            margin-bottom: 32px;
            padding: 40px 20px;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        header h1 { font-size: 2.5rem; font-weight: 800; letter-spacing: -0.02em; }
        header p { font-size: 1.1rem; opacity: 0.8; margin-top: 8px; background: none; -webkit-text-fill-color: var(--text-secondary); }
        .setup-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        .setup-card h2 { font-size: 1.1rem; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .setup-card h2::before { content: 'ðŸ”‘'; }
        .input-group { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
        @media (max-width: 600px) { .input-group { grid-template-columns: 1fr; } }
        .input-wrapper { display: flex; flex-direction: column; gap: 6px; }
        .input-wrapper label { font-size: 0.875rem; color: var(--text-secondary); font-weight: 500; }
        input, select {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 16px;
            color: var(--text-primary);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.15);
        }
        input::placeholder { color: var(--text-secondary); }
        .controls { display: flex; gap: 12px; flex-wrap: wrap; align-items: end; }
        .date-range { display: none; gap: 12px; margin-top: 12px; }
        .date-range.visible { display: flex; flex-wrap: wrap; }
        input[type="date"] { color-scheme: dark; }
        button {
            background: var(--accent-green);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        button:hover { filter: brightness(1.1); transform: translateY(-1px); }
        button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .filter-section { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }
        .filter-section summary { cursor: pointer; color: var(--text-secondary); font-size: 0.875rem; user-select: none; }
        .filter-section summary:hover { color: var(--text-primary); }
        .filter-content { margin-top: 12px; }
        .chip-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .chip {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .chip:hover { border-color: var(--accent-blue); }
        .chip.selected { background: var(--accent-blue); border-color: var(--accent-blue); }
        .chip.excluded { background: var(--accent-orange); border-color: var(--accent-orange); opacity: 0.7; text-decoration: line-through; }
        #dashboard { display: none; }
        #dashboard.visible { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: var(--card-accent, var(--accent-blue));
        }
        .stat-card.green::before { --card-accent: var(--accent-green); }
        .stat-card.purple::before { --card-accent: var(--accent-purple); }
        .stat-card.orange::before { --card-accent: var(--accent-orange); }
        .stat-card.pink::before { --card-accent: var(--accent-pink); }
        .stat-label { font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
        .stat-value { font-size: 2rem; font-weight: 700; margin: 4px 0; }
        .stat-detail { font-size: 0.85rem; color: var(--text-secondary); }
        .stat-detail .positive { color: var(--accent-green); }
        .stat-detail .negative { color: var(--accent-orange); }
        .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px; margin-bottom: 24px; }
        @media (max-width: 600px) { .chart-grid { grid-template-columns: 1fr; } }
        .chart-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }
        .chart-card h3 { font-size: 1rem; margin-bottom: 16px; color: var(--text-secondary); }
        .chart-container { position: relative; height: 250px; }
        .chart-container.tall { height: 350px; }
        .full-width { grid-column: 1 / -1; }
        /* Stretched heatmap */
        .heatmap-wrapper { overflow-x: auto; padding-bottom: 8px; }
        .heatmap { display: flex; gap: 4px; min-width: max-content; }
        .heatmap-week { display: flex; flex-direction: column; gap: 4px; }
        .heatmap-day {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            background: var(--bg-tertiary);
            transition: transform 0.1s;
        }
        .heatmap-day:hover { transform: scale(1.2); }
        .heatmap-day[data-level="1"] { background: #0e4429; }
        .heatmap-day[data-level="2"] { background: #006d32; }
        .heatmap-day[data-level="3"] { background: #26a641; }
        .heatmap-day[data-level="4"] { background: #39d353; }
        .heatmap-months { display: flex; gap: 4px; margin-bottom: 8px; font-size: 0.7rem; color: var(--text-secondary); }
        .heatmap-months span { min-width: 14px; }
        .heatmap-legend { display: flex; align-items: center; gap: 4px; margin-top: 12px; justify-content: flex-end; font-size: 0.75rem; color: var(--text-secondary); }
        .heatmap-legend span { margin: 0 4px; }
        /* Lists */
        .list-container { max-height: 400px; overflow-y: auto; }
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
            gap: 12px;
        }
        .list-item:last-child { border-bottom: none; }
        .list-item-main { flex: 1; min-width: 0; }
        .list-item-title { font-weight: 500; color: var(--accent-blue); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .list-item-meta { font-size: 0.8rem; color: var(--text-secondary); margin-top: 2px; }
        .list-item-stats { display: flex; gap: 12px; font-size: 0.85rem; color: var(--text-secondary); flex-shrink: 0; }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .badge.open { background: var(--accent-green); color: white; }
        .badge.merged { background: var(--accent-purple); color: white; }
        .badge.closed { background: var(--accent-orange); color: white; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .chart-header h3 { margin-bottom: 0; }
        .toggle-group { display: flex; align-items: center; gap: 8px; }
        .toggle-group label { font-size: 0.8rem; color: var(--text-secondary); cursor: pointer; user-select: none; }
        .toggle-group input[type="checkbox"] {
            width: 16px; height: 16px;
            accent-color: var(--accent-blue);
            cursor: pointer;
        }
        .loading::after { content: ''; animation: dots 1.5s infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60%, 100% { content: '...'; } }
        .error { background: rgba(248, 81, 73, 0.1); border: 1px solid var(--accent-orange); border-radius: 8px; padding: 12px 16px; color: var(--accent-orange); margin: 16px 0; }
        .user-header { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; }
        .user-avatar { width: 64px; height: 64px; border-radius: 50%; border: 2px solid var(--border); }
        .user-info h2 { font-size: 1.5rem; }
        .user-info p { color: var(--text-secondary); }
        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        @media (max-width: 900px) { .two-col { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>GitHub Stats</h1>
            <p>Visualize your contribution activity across all repositories</p>
        </header>

        <div class="setup-card">
            <h2>Configuration</h2>
            <div class="input-group">
                <div class="input-wrapper">
                    <label for="token">Personal Access Token</label>
                    <input type="password" id="token" placeholder="ghp_xxxxxxxxxxxx" autocomplete="off">
                </div>
                <div class="input-wrapper">
                    <label for="username">GitHub Username</label>
                    <input type="text" id="username" placeholder="octocat">
                </div>
            </div>
            <div class="controls">
                <div class="input-wrapper" style="flex: 0 0 auto;">
                    <label for="timeRange">Time Range</label>
                    <select id="timeRange">
                        <option value="7">Last 7 days</option>
                        <option value="30" selected>Last 30 days</option>
                        <option value="90">Last 90 days</option>
                        <option value="365">Last year</option>
                        <option value="custom">Custom range</option>
                    </select>
                </div>
                <button id="fetchBtn" style="margin-top: auto;">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Zm4.879-2.773 4.264 2.559a.25.25 0 0 1 0 .428l-4.264 2.559A.25.25 0 0 1 6 10.559V5.442a.25.25 0 0 1 .379-.215Z"></path></svg>
                    Fetch Stats
                </button>
            </div>
            <div id="dateRange" class="date-range">
                <div class="input-wrapper">
                    <label for="startDate">Start Date</label>
                    <input type="date" id="startDate">
                </div>
                <div class="input-wrapper">
                    <label for="endDate">End Date</label>
                    <input type="date" id="endDate">
                </div>
            </div>
            <details class="filter-section">
                <summary>Advanced Filters (click to expand)</summary>
                <div class="filter-content">
                    <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 8px;">
                        Click repos to toggle inclusion. Double-click to exclude.
                    </p>
                    <div id="repoFilters" class="chip-container">
                        <span style="color: var(--text-secondary); font-size: 0.85rem;">Fetch stats first to see repositories</span>
                    </div>
                </div>
            </details>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="dashboard">
            <div class="user-header">
                <img id="userAvatar" class="user-avatar" src="" alt="">
                <div class="user-info">
                    <h2 id="userName"></h2>
                    <p id="userBio"></p>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card green">
                    <div class="stat-label">Total Commits</div>
                    <div class="stat-value" id="totalCommits">0</div>
                    <div class="stat-detail" id="commitRate"></div>
                </div>
                <div class="stat-card purple">
                    <div class="stat-label">Lines Changed</div>
                    <div class="stat-value" id="totalLines">0</div>
                    <div class="stat-detail"><span class="positive" id="linesAdded">+0</span> / <span class="negative" id="linesRemoved">-0</span></div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-label">Pull Requests</div>
                    <div class="stat-value" id="totalPRs">0</div>
                    <div class="stat-detail" id="prDetail"></div>
                </div>
                <div class="stat-card pink">
                    <div class="stat-label">Repositories</div>
                    <div class="stat-value" id="totalRepos">0</div>
                    <div class="stat-detail" id="repoDetail"></div>
                </div>
            </div>

            <div class="chart-card">
                <h3>Contribution Activity</h3>
                <div class="heatmap-wrapper">
                    <div id="heatmapMonths" class="heatmap-months"></div>
                    <div id="heatmap" class="heatmap"></div>
                </div>
                <div class="heatmap-legend">
                    <span>Less</span>
                    <div class="heatmap-day" data-level="0"></div>
                    <div class="heatmap-day" data-level="1"></div>
                    <div class="heatmap-day" data-level="2"></div>
                    <div class="heatmap-day" data-level="3"></div>
                    <div class="heatmap-day" data-level="4"></div>
                    <span>More</span>
                </div>
            </div>

            <div class="chart-card">
                <h3>Commits by Repository Over Time</h3>
                <div class="chart-container tall"><canvas id="repoTimeChart"></canvas></div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h3>Lines of Code by Repository Over Time</h3>
                    <div class="toggle-group">
                        <input type="checkbox" id="locAbsolute">
                        <label for="locAbsolute">Show absolute values</label>
                    </div>
                </div>
                <div class="chart-container tall"><canvas id="locRepoChart"></canvas></div>
            </div>

            <div class="chart-grid">
                <div class="chart-card" style="margin-bottom: 0;">
                    <h3>Daily Commits</h3>
                    <div class="chart-container"><canvas id="commitsChart"></canvas></div>
                </div>
                <div class="chart-card" style="margin-bottom: 0;">
                    <h3>Lines of Code</h3>
                    <div class="chart-container"><canvas id="locChart"></canvas></div>
                </div>
            </div>

            <div class="two-col">
                <div class="chart-card" style="margin-bottom: 0;">
                    <h3>Recent Pull Requests</h3>
                    <div id="prList" class="list-container"></div>
                </div>
                <div class="chart-card" style="margin-bottom: 0;">
                    <h3>Top Repositories by Commits</h3>
                    <div id="reposList" class="list-container"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const $ = id => document.getElementById(id);
        let commitsChart, locChart, repoTimeChart, locRepoChart;
        let allRepos = [];
        let repoStates = {};
        let cachedLocRepoData = null; // Cache for re-rendering on toggle
        const REPO_COLORS = [
            '#58a6ff', '#a371f7', '#db61a2', '#f78166', '#d29922',
            '#3fb950', '#79c0ff', '#d2a8ff', '#ff7b72', '#ffa657'
        ];
        const GREEN_SHADES = [
            '#39d353', '#26a641', '#006d32', '#0e4429', '#2ea043',
            '#56d364', '#3fb950', '#238636', '#196c2e', '#0f5323'
        ];
        const RED_SHADES = [
            '#f85149', '#da3633', '#b62324', '#8b1c1c', '#ff7b72',
            '#ffa198', '#f78166', '#ea6045', '#cf4c3c', '#a1201c'
        ];

        const GITHUB_GRAPHQL = 'https://api.github.com/graphql';

        async function graphql(token, query, variables = {}) {
            const res = await fetch(GITHUB_GRAPHQL, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ query, variables })
            });
            const data = await res.json();
            if (data.errors) throw new Error(data.errors[0].message);
            return data.data;
        }

        function showError(msg) {
            $('error').textContent = msg;
            $('error').style.display = 'block';
        }

        function hideError() { $('error').style.display = 'none'; }

        function formatNumber(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
            return n.toLocaleString();
        }

        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        async function fetchUserData(token, username, from, to) {
            const query = `query($login: String!, $from: DateTime, $to: DateTime) {
                user(login: $login) {
                    name login avatarUrl bio
                    contributionsCollection(from: $from, to: $to) {
                        contributionCalendar { totalContributions weeks { contributionDays { contributionCount date } } }
                    }
                    repositories(first: 100, ownerAffiliations: [OWNER, COLLABORATOR, ORGANIZATION_MEMBER], orderBy: {field: PUSHED_AT, direction: DESC}) {
                        nodes { nameWithOwner isPrivate owner { login } }
                    }
                }
            }`;
            return graphql(token, query, { login: username, from, to });
        }

        async function fetchRepoCommits(token, owner, repo, username, since, until) {
            const query = `query($owner: String!, $repo: String!, $since: GitTimestamp!, $until: GitTimestamp) {
                repository(owner: $owner, name: $repo) {
                    defaultBranchRef {
                        target {
                            ... on Commit {
                                history(first: 100, since: $since, until: $until) {
                                    nodes { committedDate author { user { login } } additions deletions }
                                }
                            }
                        }
                    }
                }
            }`;
            try {
                const data = await graphql(token, query, { owner, repo, since, until });
                const commits = data.repository?.defaultBranchRef?.target?.history?.nodes || [];
                return commits.filter(c => c.author?.user?.login === username);
            } catch { return []; }
        }

        async function fetchPRs(token, username, since, until) {
            const query = `query($query: String!) {
                search(query: $query, type: ISSUE, first: 100) {
                    nodes {
                        ... on PullRequest { title state createdAt mergedAt url repository { nameWithOwner } }
                    }
                }
            }`;
            const sinceDate = since.split('T')[0];
            const untilDate = until.split('T')[0];
            const data = await graphql(token, query, { query: `author:${username} type:pr created:${sinceDate}..${untilDate}` });
            return data.search.nodes;
        }

        function updateRepoFilters() {
            const container = $('repoFilters');
            container.innerHTML = '';
            allRepos.forEach(repo => {
                const chip = document.createElement('span');
                chip.className = 'chip' + (repoStates[repo] === 'selected' ? ' selected' : repoStates[repo] === 'excluded' ? ' excluded' : '');
                chip.textContent = repo;
                chip.onclick = () => {
                    if (repoStates[repo] === 'excluded') delete repoStates[repo];
                    else if (repoStates[repo] === 'selected') delete repoStates[repo];
                    else repoStates[repo] = 'selected';
                    updateRepoFilters();
                };
                chip.ondblclick = () => { repoStates[repo] = 'excluded'; updateRepoFilters(); };
                container.appendChild(chip);
            });
        }

        function getFilteredRepos() {
            const selected = Object.entries(repoStates).filter(([_, v]) => v === 'selected').map(([k]) => k);
            const excluded = Object.entries(repoStates).filter(([_, v]) => v === 'excluded').map(([k]) => k);
            if (selected.length > 0) return allRepos.filter(r => selected.includes(r));
            return allRepos.filter(r => !excluded.includes(r));
        }

        function renderHeatmap(weeks) {
            const container = $('heatmap');
            const monthsContainer = $('heatmapMonths');
            container.innerHTML = '';
            monthsContainer.innerHTML = '';

            const months = [];
            let lastMonth = '';

            weeks.forEach((week, weekIndex) => {
                const weekDiv = document.createElement('div');
                weekDiv.className = 'heatmap-week';

                week.contributionDays.forEach((day, dayIndex) => {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'heatmap-day';
                    const count = day.contributionCount;
                    const level = count === 0 ? 0 : count <= 3 ? 1 : count <= 6 ? 2 : count <= 9 ? 3 : 4;
                    dayDiv.setAttribute('data-level', level);
                    dayDiv.title = `${day.date}: ${count} contributions`;
                    weekDiv.appendChild(dayDiv);

                    if (dayIndex === 0) {
                        const month = new Date(day.date).toLocaleDateString('en-US', { month: 'short' });
                        if (month !== lastMonth) {
                            months.push({ month, weekIndex });
                            lastMonth = month;
                        }
                    }
                });
                container.appendChild(weekDiv);
            });

            // Render month labels
            let pos = 0;
            months.forEach((m, i) => {
                const span = document.createElement('span');
                span.textContent = m.month;
                span.style.marginLeft = i === 0 ? '0' : `${(m.weekIndex - pos - 1) * 18}px`;
                monthsContainer.appendChild(span);
                pos = m.weekIndex;
            });
        }

        function renderCharts(commitsByDate, locByDate, commitsByRepoDate, topRepos) {
            const labels = Object.keys(commitsByDate).sort();
            const commitData = labels.map(d => commitsByDate[d] || 0);
            const addData = labels.map(d => locByDate[d]?.additions || 0);
            const delData = labels.map(d => -(locByDate[d]?.deletions || 0));

            const chartConfig = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { color: '#30363d' }, ticks: { color: '#8b949e', maxTicksLimit: 8 } },
                    y: { grid: { color: '#30363d' }, ticks: { color: '#8b949e' } }
                }
            };

            if (commitsChart) commitsChart.destroy();
            commitsChart = new Chart($('commitsChart'), {
                type: 'bar',
                data: { labels, datasets: [{ data: commitData, backgroundColor: 'rgba(88, 166, 255, 0.8)', borderRadius: 4 }] },
                options: chartConfig
            });

            if (locChart) locChart.destroy();
            locChart = new Chart($('locChart'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: 'Added', data: addData, backgroundColor: 'rgba(35, 134, 54, 0.8)', borderRadius: 4 },
                        { label: 'Removed', data: delData, backgroundColor: 'rgba(248, 81, 102, 0.8)', borderRadius: 4 }
                    ]
                },
                options: { ...chartConfig, plugins: { legend: { display: true, labels: { color: '#8b949e' } } }, scales: { ...chartConfig.scales, x: { ...chartConfig.scales.x, stacked: true }, y: { ...chartConfig.scales.y, stacked: true } } }
            });

            // Stacked area chart by repo
            if (repoTimeChart) repoTimeChart.destroy();
            const datasets = topRepos.slice(0, 8).map((repo, i) => ({
                label: repo.split('/').pop(),
                data: labels.map(d => commitsByRepoDate[repo]?.[d] || 0),
                backgroundColor: REPO_COLORS[i % REPO_COLORS.length] + '80',
                borderColor: REPO_COLORS[i % REPO_COLORS.length],
                borderWidth: 1,
                fill: true
            }));

            repoTimeChart = new Chart($('repoTimeChart'), {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true, position: 'top', labels: { color: '#8b949e', boxWidth: 12, padding: 8 } } },
                    scales: {
                        x: { grid: { color: '#30363d' }, ticks: { color: '#8b949e', maxTicksLimit: 10 } },
                        y: { stacked: true, grid: { color: '#30363d' }, ticks: { color: '#8b949e' } }
                    },
                    elements: { line: { tension: 0.3 }, point: { radius: 0 } }
                }
            });
        }

        function renderLocRepoChart(locByRepoDate, topRepos, labels, useAbsolute = false) {
            if (locRepoChart) locRepoChart.destroy();

            const reposToShow = topRepos.slice(0, 8);
            const datasets = [];

            // Additions (green shades) - stacked positive
            reposToShow.forEach((repo, i) => {
                const data = labels.map(d => locByRepoDate[repo]?.[d]?.additions || 0);
                datasets.push({
                    label: `+${repo.split('/').pop()}`,
                    data,
                    backgroundColor: GREEN_SHADES[i % GREEN_SHADES.length] + 'cc',
                    borderColor: GREEN_SHADES[i % GREEN_SHADES.length],
                    borderWidth: 1,
                    stack: 'additions'
                });
            });

            // Deletions (red shades) - stacked negative (or positive if absolute)
            reposToShow.forEach((repo, i) => {
                const rawData = labels.map(d => locByRepoDate[repo]?.[d]?.deletions || 0);
                const data = useAbsolute ? rawData : rawData.map(v => -v);
                datasets.push({
                    label: `-${repo.split('/').pop()}`,
                    data,
                    backgroundColor: RED_SHADES[i % RED_SHADES.length] + 'cc',
                    borderColor: RED_SHADES[i % RED_SHADES.length],
                    borderWidth: 1,
                    stack: useAbsolute ? 'deletions' : 'deletions'
                });
            });

            locRepoChart = new Chart($('locRepoChart'), {
                type: 'bar',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#8b949e',
                                boxWidth: 10,
                                padding: 6,
                                font: { size: 10 },
                                filter: (item) => item.text.startsWith('+') // Only show additions in legend
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const val = Math.abs(ctx.raw);
                                    const sign = ctx.dataset.label.startsWith('+') ? '+' : '-';
                                    return `${ctx.dataset.label.slice(1)}: ${sign}${formatNumber(val)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { stacked: true, grid: { color: '#30363d' }, ticks: { color: '#8b949e', maxTicksLimit: 10 } },
                        y: { stacked: true, grid: { color: '#30363d' }, ticks: { color: '#8b949e' } }
                    }
                }
            });
        }

        function renderPRList(prs) {
            const container = $('prList');
            if (prs.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No pull requests in this period</p>';
                return;
            }
            const sorted = [...prs].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            container.innerHTML = sorted.slice(0, 15).map(pr => {
                const state = pr.state.toLowerCase();
                const stateClass = state === 'merged' ? 'merged' : state === 'open' ? 'open' : 'closed';
                return `
                <div class="list-item">
                    <div class="list-item-main">
                        <div class="list-item-title" title="${pr.title}">${pr.title}</div>
                        <div class="list-item-meta">${pr.repository.nameWithOwner} &bull; ${formatDate(pr.createdAt)}</div>
                    </div>
                    <span class="badge ${stateClass}">${pr.state}</span>
                </div>`;
            }).join('');
        }

        function renderReposList(repoStats) {
            const sorted = Object.entries(repoStats).sort((a, b) => b[1].commits - a[1].commits).slice(0, 15);
            const container = $('reposList');
            if (sorted.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No commits in this period</p>';
                return;
            }
            container.innerHTML = sorted.map(([name, stats], i) => `
                <div class="list-item">
                    <div class="list-item-main">
                        <div class="list-item-title" style="color: ${REPO_COLORS[i % REPO_COLORS.length]}">${name}</div>
                    </div>
                    <div class="list-item-stats">
                        <span>${stats.commits} commits</span>
                        <span class="positive">+${formatNumber(stats.additions)}</span>
                        <span class="negative">-${formatNumber(stats.deletions)}</span>
                    </div>
                </div>
            `).join('');
        }

        function getDateRange() {
            const rangeValue = $('timeRange').value;
            if (rangeValue === 'custom') {
                const start = $('startDate').value;
                const end = $('endDate').value;
                if (!start || !end) return null;
                return {
                    since: new Date(start).toISOString(),
                    until: new Date(end + 'T23:59:59').toISOString(),
                    days: Math.ceil((new Date(end) - new Date(start)) / 86400000) + 1
                };
            }
            const days = parseInt(rangeValue);
            return {
                since: new Date(Date.now() - days * 86400000).toISOString(),
                until: new Date().toISOString(),
                days
            };
        }

        async function fetchStats() {
            const token = $('token').value.trim();
            const username = $('username').value.trim();
            const dateRange = getDateRange();

            if (!token || !username) { showError('Please enter both token and username'); return; }
            if (!dateRange) { showError('Please select both start and end dates'); return; }
            hideError();

            const btn = $('fetchBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading">Fetching</span>';

            try {
                const { since, until, days } = dateRange;
                const userData = await fetchUserData(token, username, since, until);
                const user = userData.user;

                $('userAvatar').src = user.avatarUrl;
                $('userName').textContent = user.name || user.login;
                $('userBio').textContent = user.bio || '';

                allRepos = user.repositories.nodes.map(r => r.nameWithOwner);
                updateRepoFilters();

                const filteredRepos = getFilteredRepos();
                const commitsByDate = {}, locByDate = {}, repoStats = {}, commitsByRepoDate = {}, locByRepoDate = {};
                let totalCommits = 0, totalAdded = 0, totalRemoved = 0;

                for (const repoName of filteredRepos.slice(0, 30)) {
                    const [owner, repo] = repoName.split('/');
                    const commits = await fetchRepoCommits(token, owner, repo, username, since, until);
                    if (commits.length === 0) continue;

                    repoStats[repoName] = { commits: commits.length, additions: 0, deletions: 0 };
                    commitsByRepoDate[repoName] = {};
                    locByRepoDate[repoName] = {};

                    commits.forEach(c => {
                        const date = c.committedDate.split('T')[0];
                        commitsByDate[date] = (commitsByDate[date] || 0) + 1;
                        commitsByRepoDate[repoName][date] = (commitsByRepoDate[repoName][date] || 0) + 1;
                        locByDate[date] = locByDate[date] || { additions: 0, deletions: 0 };
                        locByDate[date].additions += c.additions;
                        locByDate[date].deletions += c.deletions;
                        locByRepoDate[repoName][date] = locByRepoDate[repoName][date] || { additions: 0, deletions: 0 };
                        locByRepoDate[repoName][date].additions += c.additions;
                        locByRepoDate[repoName][date].deletions += c.deletions;
                        repoStats[repoName].additions += c.additions;
                        repoStats[repoName].deletions += c.deletions;
                        totalCommits++;
                        totalAdded += c.additions;
                        totalRemoved += c.deletions;
                    });
                }

                const prs = await fetchPRs(token, username, since, until);
                const openPRs = prs.filter(p => p.state === 'OPEN').length;
                const mergedPRs = prs.filter(p => p.state === 'MERGED').length;

                $('totalCommits').textContent = formatNumber(totalCommits);
                $('commitRate').textContent = `~${(totalCommits / days).toFixed(1)} per day`;
                $('totalLines').textContent = formatNumber(totalAdded + totalRemoved);
                $('linesAdded').textContent = '+' + formatNumber(totalAdded);
                $('linesRemoved').textContent = '-' + formatNumber(totalRemoved);
                $('totalPRs').textContent = prs.length;
                $('prDetail').textContent = `${openPRs} open, ${mergedPRs} merged`;
                $('totalRepos').textContent = Object.keys(repoStats).length;
                $('repoDetail').textContent = `of ${filteredRepos.length} tracked`;

                const calendar = user.contributionsCollection.contributionCalendar;
                const topRepos = Object.entries(repoStats).sort((a, b) => b[1].commits - a[1].commits).map(([name]) => name);
                const labels = Object.keys(commitsByDate).sort();

                // Cache data for LOC chart toggle
                cachedLocRepoData = { locByRepoDate, topRepos, labels };

                renderHeatmap(calendar.weeks);
                renderCharts(commitsByDate, locByDate, commitsByRepoDate, topRepos);
                renderLocRepoChart(locByRepoDate, topRepos, labels, $('locAbsolute').checked);
                renderPRList(prs);
                renderReposList(repoStats);

                $('dashboard').classList.add('visible');
            } catch (e) {
                showError(e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Zm4.879-2.773 4.264 2.559a.25.25 0 0 1 0 .428l-4.264 2.559A.25.25 0 0 1 6 10.559V5.442a.25.25 0 0 1 .379-.215Z"></path></svg> Fetch Stats';
            }
        }

        $('fetchBtn').onclick = fetchStats;
        $('token').addEventListener('keypress', e => { if (e.key === 'Enter') fetchStats(); });
        $('username').addEventListener('keypress', e => { if (e.key === 'Enter') fetchStats(); });

        $('timeRange').addEventListener('change', () => {
            $('dateRange').classList.toggle('visible', $('timeRange').value === 'custom');
        });

        // LOC chart absolute toggle
        $('locAbsolute').addEventListener('change', () => {
            if (cachedLocRepoData) {
                const { locByRepoDate, topRepos, labels } = cachedLocRepoData;
                renderLocRepoChart(locByRepoDate, topRepos, labels, $('locAbsolute').checked);
            }
        });

        const today = new Date().toISOString().split('T')[0];
        const thirtyDaysAgo = new Date(Date.now() - 30 * 86400000).toISOString().split('T')[0];
        $('endDate').value = today;
        $('startDate').value = thirtyDaysAgo;
        $('endDate').max = today;

        if (localStorage.getItem('gh-stats-token')) $('token').value = localStorage.getItem('gh-stats-token');
        if (localStorage.getItem('gh-stats-username')) $('username').value = localStorage.getItem('gh-stats-username');
        $('token').addEventListener('change', () => localStorage.setItem('gh-stats-token', $('token').value));
        $('username').addEventListener('change', () => localStorage.setItem('gh-stats-username', $('username').value));
    </script>
</body>
</html>
